{"version":3,"file":"builder.js","sourceRoot":"","sources":["../../src/formatter/builder.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventEmitter } from 'node:events'\nimport { Writable as WritableStream } from 'node:stream'\nimport { doesHaveValue, doesNotHaveValue } from '../value_checker'\nimport { SupportCodeLibrary } from '../support_code_library_builder/types'\nimport { SnippetInterface } from './step_definition_snippet_builder/snippet_syntax'\nimport EventDataCollector from './helpers/event_data_collector'\nimport StepDefinitionSnippetBuilder from './step_definition_snippet_builder'\nimport JavascriptSnippetSyntax from './step_definition_snippet_builder/javascript_snippet_syntax'\nimport getColorFns from './get_color_fns'\nimport Formatters from './helpers/formatters'\nimport { importCode } from './import_code'\nimport Formatter, {\n  FormatOptions,\n  IFormatterCleanupFn,\n  IFormatterLogFn,\n} from '.'\n\ninterface IGetStepDefinitionSnippetBuilderOptions {\n  cwd: string\n  snippetInterface?: SnippetInterface\n  snippetSyntax?: string\n  supportCodeLibrary: SupportCodeLibrary\n}\n\nexport interface IBuildOptions {\n  env: NodeJS.ProcessEnv\n  cwd: string\n  eventBroadcaster: EventEmitter\n  eventDataCollector: EventDataCollector\n  log: IFormatterLogFn\n  parsedArgvOptions: FormatOptions\n  stream: WritableStream\n  cleanup: IFormatterCleanupFn\n  supportCodeLibrary: SupportCodeLibrary\n}\n\nconst FormatterBuilder = {\n  async build(\n    FormatterConstructor: string | typeof Formatter,\n    options: IBuildOptions\n  ): Promise<Formatter> {\n    if (typeof FormatterConstructor === 'string') {\n      FormatterConstructor = await FormatterBuilder.getConstructorByType(\n        FormatterConstructor,\n        options.cwd\n      )\n    }\n    const colorFns = getColorFns(\n      options.stream,\n      options.env,\n      options.parsedArgvOptions.colorsEnabled\n    )\n    const snippetBuilder =\n      await FormatterBuilder.getStepDefinitionSnippetBuilder({\n        cwd: options.cwd,\n        snippetInterface: options.parsedArgvOptions.snippetInterface,\n        snippetSyntax: options.parsedArgvOptions.snippetSyntax,\n        supportCodeLibrary: options.supportCodeLibrary,\n      })\n    return new FormatterConstructor({\n      colorFns,\n      snippetBuilder,\n      ...options,\n    })\n  },\n\n  async getConstructorByType(\n    type: string,\n    cwd: string\n  ): Promise<typeof Formatter> {\n    const formatters: Record<string, typeof Formatter> =\n      Formatters.getFormatters()\n\n    return formatters[type]\n      ? formatters[type]\n      : await FormatterBuilder.loadCustomClass('formatter', type, cwd)\n  },\n\n  async getStepDefinitionSnippetBuilder({\n    cwd,\n    snippetInterface,\n    snippetSyntax,\n    supportCodeLibrary,\n  }: IGetStepDefinitionSnippetBuilderOptions) {\n    if (doesNotHaveValue(snippetInterface)) {\n      snippetInterface = SnippetInterface.Synchronous\n    }\n    let Syntax = JavascriptSnippetSyntax\n    if (doesHaveValue(snippetSyntax)) {\n      Syntax = await FormatterBuilder.loadCustomClass(\n        'syntax',\n        snippetSyntax,\n        cwd\n      )\n    }\n    return new StepDefinitionSnippetBuilder({\n      snippetSyntax: new Syntax(snippetInterface),\n      parameterTypeRegistry: supportCodeLibrary.parameterTypeRegistry,\n    })\n  },\n\n  async loadCustomClass(\n    type: 'formatter' | 'syntax',\n    descriptor: string,\n    cwd: string\n  ) {\n    const CustomClass = FormatterBuilder.resolveConstructor(\n      await importCode(descriptor, cwd)\n    )\n    if (doesHaveValue(CustomClass)) {\n      return CustomClass\n    } else {\n      throw new Error(\n        `Custom ${type} (${descriptor}) does not export a function/class`\n      )\n    }\n  },\n\n  async loadFile(urlOrName: URL | string) {\n    return await import(urlOrName.toString())\n  },\n\n  resolveConstructor(ImportedCode: any) {\n    if (doesNotHaveValue(ImportedCode)) {\n      return null\n    }\n    if (typeof ImportedCode === 'function') {\n      return ImportedCode\n    } else if (\n      typeof ImportedCode === 'object' &&\n      typeof ImportedCode.default === 'function'\n    ) {\n      return ImportedCode.default\n    } else if (\n      typeof ImportedCode.default === 'object' &&\n      typeof ImportedCode.default.default === 'function'\n    ) {\n      return ImportedCode.default.default\n    }\n    return null\n  },\n}\n\nexport default FormatterBuilder\n"]}